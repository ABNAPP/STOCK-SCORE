rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user role from custom claims
    function getUserRole() {
      return request.auth.token.role;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return getUserRole() == 'admin';
    }
    
    // Helper function to check if user has any role (admin or viewer)
    function hasRole() {
      return getUserRole() == 'viewer' || isAdmin();
    }
    
    // Helper function to get viewer allowed views from custom claims
    function getViewerAllowedViews() {
      return request.auth.token.allowedViews;
    }
    
    // Helper function to validate EntryExit value structure
    function isValidEntryExitValue(value) {
      return value.keys().hasAll(['entry1', 'entry2', 'exit1', 'exit2', 'currency']) &&
             value.entry1 is number && value.entry1 >= 0 && value.entry1 <= 1000000 &&
             value.entry2 is number && value.entry2 >= 0 && value.entry2 <= 1000000 &&
             value.exit1 is number && value.exit1 >= 0 && value.exit1 <= 1000000 &&
             value.exit2 is number && value.exit2 >= 0 && value.exit2 <= 1000000 &&
             value.currency is string && value.currency in ['USD', 'EUR', 'SEK', 'DKK', 'NOK', 'GBP', 'AUD', 'CAD', 'NZD'] &&
             (value.dateOfUpdate == null || (value.dateOfUpdate is string && value.dateOfUpdate.matches('^\\d{4}-\\d{2}-\\d{2}$')));
    }
    
    // Helper function to validate EntryExit document structure
    function isValidEntryExitDocument(data) {
      // Check document size (max 1MB)
      return data.size() <= 1048576 &&
             // Validate that values is a map
             data.values is map &&
             // Validate that all values in the map are valid EntryExit values
             // Note: Firestore rules don't support iterating over map values directly,
             // so we validate on write operations instead
             true;
    }
    
    // Shared data - read access for all (including unauthenticated for Score data), write access only for admin
    match /sharedData/{document} {
      // Threshold data - only admin can read/write
      match /threshold/{thresholdId} {
        allow read, write: if isAdmin();
      }
      
      // EntryExit data - available for Score table
      match /entryExit {
        // Read: All users (including unauthenticated viewers) can read for Score table
        // Note: UI-level restrictions based on allowedViews will be enforced in the application
        allow read: if true;
        
        // Write: Only admin
        allow write: if request.auth != null && 
                        isAdmin() && 
                        request.resource.data.size() <= 1048576 &&
                        request.resource.data.values is map;
      }
      
      // All other shared data
      match /{sharedDoc=**} {
        // Read: All users (including unauthenticated viewers) for Score-related data
        allow read: if true;
        
        // Write: Only admin
        allow write: if request.auth != null && 
                        isAdmin() && 
                        request.resource.data.size() <= 1048576; // 1MB limit
      }
    }
    
    // User preferences - users can read/write their own preferences (requires authentication)
    match /userPreferences/{userId} {
      // Users can only access their own preferences
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Validate structure on write
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.userId == userId &&
                      request.resource.data.size() <= 10240; // 10KB limit
    }
    
    // User portfolios - users can read/write their own portfolio (requires authentication)
    match /userPortfolios/{userId} {
      // Users can only access their own portfolio
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Validate structure on write
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.userId == userId &&
                      request.resource.data.size() <= 5242880 && // 5MB limit
                      request.resource.data.portfolio is list;
    }
    
    // App cache - shared cache for all users (including unauthenticated)
    match /appCache/{cacheKey} {
      // Read: All users (including unauthenticated viewers)
      allow read: if true;
      
      // Write: Only admin, with validation
      // Validate document structure: must have data, timestamp, and ttl
      allow write: if request.auth != null && 
                      isAdmin() &&
                      request.resource.data.size() <= 10485760 && // 10MB limit
                      request.resource.data.data != null &&
                      request.resource.data.timestamp is number &&
                      request.resource.data.ttl is number;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
