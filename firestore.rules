rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user role from custom claims
    function getUserRole() {
      return request.auth.token.role;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return getUserRole() == 'admin';
    }
    
    // Helper function to check if user has any role (admin or viewer)
    function hasRole() {
      return getUserRole() == 'viewer' || isAdmin();
    }
    
    // Helper function to get viewer allowed views from custom claims
    function getViewerAllowedViews() {
      return request.auth.token.allowedViews;
    }
    
    // Helper function to validate EntryExit value structure
    function isValidEntryExitValue(value) {
      return value.keys().hasAll(['entry1', 'entry2', 'exit1', 'exit2', 'currency']) &&
             value.entry1 is number && value.entry1 >= 0 && value.entry1 <= 1000000 &&
             value.entry2 is number && value.entry2 >= 0 && value.entry2 <= 1000000 &&
             value.exit1 is number && value.exit1 >= 0 && value.exit1 <= 1000000 &&
             value.exit2 is number && value.exit2 >= 0 && value.exit2 <= 1000000 &&
             value.currency is string && value.currency in ['USD', 'EUR', 'SEK', 'DKK', 'NOK', 'GBP', 'AUD', 'CAD', 'NZD'] &&
             (value.dateOfUpdate == null || (value.dateOfUpdate is string && value.dateOfUpdate.matches('^\\d{4}-\\d{2}-\\d{2}$')));
    }
    
    // Helper function to validate EntryExit document structure
    function isValidEntryExitDocument(data) {
      // Check document size (max 1MB)
      return data.size() <= 1048576 &&
             // Validate that values is a map
             data.values is map &&
             // Validate that all values in the map are valid EntryExit values
             // Note: Firestore rules don't support iterating over map values directly,
             // so we validate on write operations instead
             true;
    }
    
    // sharedData/threshold document - only admin can read/write (overrides catch-all below)
    match /sharedData/threshold {
      allow read, write: if isAdmin();
    }
    
    // Shared data - read requires authentication and role (viewer or admin), write only for admin
    match /sharedData/{document} {
      // Threshold subcollection (sharedData/threshold/{thresholdId}) - only admin
      match /threshold/{thresholdId} {
        allow read, write: if isAdmin();
      }
      
      // EntryExit data - available for Score table
      match /entryExit {
        // Read: Authenticated users with role (viewer or admin)
        allow read: if request.auth != null && hasRole();
        
        // Write: Only admin
        allow write: if request.auth != null && 
                        isAdmin() && 
                        request.resource.data.size() <= 1048576 &&
                        request.resource.data.values is map;
      }
      
      // All other shared data (excluding threshold document - see sharedData/threshold rule above)
      match /{sharedDoc=**} {
        // Read: Authenticated users with role; threshold doc handled by explicit rule
        allow read: if request.auth != null && hasRole() && document != 'threshold';
        
        // Write: Only admin
        allow write: if request.auth != null && 
                        isAdmin() && 
                        request.resource.data.size() <= 1048576; // 1MB limit
      }
    }
    
    // User preferences - users can read/write their own preferences (requires authentication)
    match /userPreferences/{userId} {
      // Users can only access their own preferences
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Validate structure on write
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.userId == userId &&
                      request.resource.data.size() <= 10240; // 10KB limit
    }
    
    // User portfolios - users can read/write their own portfolio (requires authentication)
    match /userPortfolios/{userId} {
      // Users can only access their own portfolio
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Validate structure on write
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.data.userId == userId &&
                      request.resource.data.size() <= 5242880 && // 5MB limit
                      request.resource.data.portfolio is list;
    }
    
    // App config - API keys
    // Read: All authenticated users (needed for currency exchange rates)
    // Write: Only admin (only admin can view/edit in UI)
    match /appConfig/apiKeys {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isAdmin();
    }
    
    // Currency rates cache - any authenticated user can read/write (first user to need fresh rates populates for all)
    match /appCache/currency_rates_usd {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null &&
                              request.resource.data.size() <= 10485760 &&
                              request.resource.data.data != null &&
                              request.resource.data.timestamp is number &&
                              request.resource.data.ttl is number;
      allow delete: if request.auth != null && isAdmin();
    }
    
    // App cache - shared cache; Viewer can read only Score-view docs, Admin can read all
    match /appCache/{cacheKey} {
      // Read: Admin all; Viewer only scoreBoard, benjaminGraham, peIndustry, sma, currency_rates_usd
      allow read: if request.auth != null && (
        isAdmin() ||
        cacheKey == 'scoreBoard' ||
        cacheKey == 'benjaminGraham' ||
        cacheKey == 'peIndustry' ||
        cacheKey == 'sma' ||
        cacheKey == 'currency_rates_usd'
      );
      
      // Delete: Only admin (no data validation needed for delete)
      allow delete: if request.auth != null && isAdmin();
      
      // Create/Update: Only admin, with validation
      // Validate document structure: must have data, timestamp, and ttl
      allow create, update: if request.auth != null && 
                              isAdmin() &&
                              request.resource.data.size() <= 10485760 && // 10MB limit
                              request.resource.data.data != null &&
                              request.resource.data.timestamp is number &&
                              request.resource.data.ttl is number;
    }
    
    // Shareable links - authenticated users can read (to load shared links); create/update/delete only by creator
    match /shareableLinks/{linkId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.createdBy == request.auth.uid;
    }
    
    // User data - created on signup (Cloud Function); user reads own doc, admin reads/writes all
    match /userData/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow write: if request.auth != null && isAdmin();
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
